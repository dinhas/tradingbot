# ðŸ›¡ï¸ TradeGuard: The Intelligent Trade Filter Model

TradeGuard is a secondary validation layer designed to "gatekeep" trades generated by the Alpha model and sized by the Risk Layer. Its primary objective is to improve the overall win rate and reduce maximum drawdown by predicting the probability of a trade being successful *before* execution.

## ðŸ—ï¸ System Architecture

The trading pipeline flow is as follows:

1. **Market Data** â†’ **Alpha Model** (Signal Direction & Confidence)
2. **Signal + Market State** â†’ **Risk Layer** (SL, TP, and Lot Sizing)
3. **Full Trade Setup + Context** â†’ **TradeGuard** (Execution Approval)
4. **Final Decision** â†’ **Broker execution** (or Skip)

---

## ðŸ“Š Feature Space (95-100 Features)

TradeGuard uses a comprehensive set of features representing the market regime, the intended trade setup, and the current account health.

### 1. Market Context (60 Features) - Derived from Alpha
*   **Price Action (15):** 1-period and 12-period returns, normalized close price for all 5 pairs (EURUSD, GBPUSD, USDJPY, USDCHF, XAUUSD).
*   **Volatility (15):** ATR (14-period), ATR Ratios, and Bollinger Band positions for all assets.
*   **Trend (10):** Price vs EMA9 and EMA9 vs EMA21 divergence for all assets.
*   **Momentum (10):** RSI (14-period) and MACD Histograms for all assets.
*   **Cross-Asset (10):** Basket correlation and Relative Strength (vs Basket) for all assets.

### 2. Risk Layer Outputs (15 Features)
*   **Setup:** `sl_mult`, `tp_mult`, `risk_pct` (Action raw values).
*   **Distances:** `sl_dist_atr`, `tp_dist_atr`.
*   **Economics:** `rr_ratio` (TP/SL), `actual_risk_pct`, `lots`, `position_value_usd`.
*   **Confidence Indicators:** `is_near_block_threshold`, `risk_cap_mult`.
*   **Efficiency:** `risk_per_lot`, `leverage_used`.

### 3. Trade Specifics & Context (10 Features)
*   **Direction:** Long (+1) or Short (-1).
*   **Asset:** Encoded Symbol ID.
*   **Regime:** Current ATR Percentile, Confluence (count of other active signals).
*   **History:** Current Win/Loss streaks from the last N trades.

### 4. Session & Temporal (8 Features)
*   **Cyclical:** `hour_sin`, `hour_cos`, `day_sin`, `day_cos`.
*   **Sessions:** `session_asian`, `session_london`, `session_ny`, `session_overlap`.

### 5. Account State (5 Features)
*   **Health:** `equity_normalized`, `drawdown_pct`.
*   **Load:** `margin_usage_pct`, `num_open_positions`.
*   **Performance:** 5-period moving average of PnL%.

---

## ðŸ”„ Output Space & Decision Logic

### Recommended Strategy: Probability Score (P-Win)
TradeGuard will output a calibrated probability $P(\text{win}) \in [0, 1]$.

*   **Decision Rule:** `if P(win) > threshold: EXECUTE else: SKIP`
*   **Advantage:** Allows post-training adjustment of "aggressiveness". If market conditions get choppy, increase the threshold to 0.35; if trending, lower it to 0.20.

---

## ðŸ§  Model Training Approach

### Phase 1: Gradient Boosting with LightGBM (Primary Engine)
*   **Model:** `lightgbm.LGBMClassifier`
*   **Rationale:**
    *   **Leaf-wise growth:** Captures complex non-linear interactions better than XGBoost.
    *   **Speed:** 10x faster training on the ~350k trade dataset.
    *   **Imbalance Handling:** Native `is_unbalance=True` support to handle the 14% win rate.
    *   **Categorical Support:** Native handling of Symbol IDs and Sessions.
*   **Label:** Oracle-derived `outcome` (1 if PnL > 0 else 0).

### Phase 2: Reinforcement Learning (Refinement)
*   **Method:** Contextual Bandits (simplest RL for decision-per-signal).
*   **Reward Function:**
    *   **Took + Won:** Positive reward scaled by $R$-multiple.
    *   **Took + Lost:** Negative reward scaled by loss.
    *   **Skipped + Lost:** Positive reward for "Avoided Loss".
    *   **Skipped + Won:** High negative reward for "Opportunity Cost".

---

## ðŸ“… Roadmap

1. **Data Generation (2016-2024):** Run the full Alpha + Risk pipeline historically to generate a labeled dataset of ~350,000 trades.
2. **Feature Extraction:** Concatenate market snapshots with Risk Layer decisions.
3. **Training:** Fit the LightGBM classifier with class-weighting (to handle the 14% baseline win rate).
4. **Validation:** Backtest the "Filtered" strategy against the 2025 performance.
5. **Live Integration:** Add the TradeGuard filter node to the bridge execution script.
