I found **one clear bug** and several potential issues in the TradeGuard training pipeline:

## üêõ **Critical Bug Found**

### Episode Termination Logic Error
**Location:** `generate_dataset.py`, line ~187

```python
obs, _, _, truncated, _ = self.env.step(alpha_action)
done = truncated
```

**Problem:** The loop only stops on `truncated` (timeout) but ignores `terminated` (natural episode end). If the environment signals termination before truncation, the loop will continue incorrectly.

**Fix:**
```python
obs, _, terminated, truncated, _ = self.env.step(alpha_action)
done = terminated or truncated
```

---

## ‚ö†Ô∏è **Potential Issues (Not Bugs, But Worth Checking)**

### 1. **Missing Validation of Simulation Results**
**Location:** `generate_dataset.py`, line ~157-158

```python
sim_result = self.env._simulate_trade_outcome_with_timing(asset)
pnl = sim_result['pnl']
close_step = current_idx + sim_result['bars_held']
```

**Issue:** No validation that `sim_result` contains required keys. If `_simulate_trade_outcome_with_timing()` fails or returns unexpected structure, this will crash.

**Recommended Fix:**
```python
sim_result = self.env._simulate_trade_outcome_with_timing(asset)
if 'pnl' not in sim_result or 'bars_held' not in sim_result:
    logger.warning(f"Invalid simulation result for {asset}")
    continue
pnl = sim_result['pnl']
close_step = current_idx + sim_result['bars_held']
```

### 2. **Hardcoded Dummy Position Size**
**Location:** `generate_dataset.py`, line ~140

```python
'size': 1.0, # Dummy size for PnL calc
```

**Issue:** If the environment's simulation logic uses position size in its PnL calculations, this dummy value could produce unrealistic training labels. The actual size should match what the Risk model would allocate.

### 3. **Minor Time-Series Split Imperfection**
**Location:** `train_guard.py`, line ~64

The 80/20 split works on row indices, but multiple trades from the same timestamp (different assets) might straddle the split boundary. This creates minor data leakage, though probably negligible in practice.

---

## ‚úÖ **What's Actually Working Well**

- Portfolio management logic with no-pyramiding and reversal rules
- Memory-efficient chunked data generation
- Proper categorical encoding with 'UNKNOWN' fallback
- Feature validation in inference
- Distribution checks between train/test

**Verdict:** Fix the termination bug immediately. The other issues are edge cases worth validating but won't break functionality under normal conditions.@rs